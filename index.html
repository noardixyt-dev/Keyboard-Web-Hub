<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Melatonin | Soft Echo</title>
    <style>
        :root {
            --bg: #1a1a25;
            --accent: #ffb7ce;
            --player: #a2d2ff;
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            margin: 0; background: var(--bg);
            color: white; font-family: 'Inter', sans-serif;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden;
        }

        .container {
            width: 800px; padding: 50px;
            background: var(--glass);
            backdrop-filter: blur(40px);
            border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .timeline-container {
            position: relative;
            width: 100%; height: 100px;
            background: rgba(255,255,255,0.02);
            border-radius: 20px;
            margin: 40px 0;
            display: flex; align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }

        #seeker {
            position: absolute;
            left: 0; width: 4px; height: 100%;
            background: white;
            box-shadow: 0 0 20px white;
            z-index: 10;
        }

        .note {
            position: absolute;
            width: 40px; height: 40px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--accent);
            transform: translateX(-50%);
            transition: all 0.3s ease;
        }

        .note.hit { background: var(--accent); box-shadow: 0 0 30px var(--accent); }
        .note.success { border-color: var(--player); background: var(--player); box-shadow: 0 0 30px var(--player); }
        .note.off-key { border-color: #b19cd9; background: rgba(177, 156, 217, 0.5); }

        .status { font-size: 22px; font-weight: 200; letter-spacing: 8px; text-transform: uppercase; color: var(--accent); }
        
        button {
            background: white; color: #1a1a25; border: none; padding: 18px 50px;
            border-radius: 100px; font-weight: 800; cursor: pointer; transition: 0.3s;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="status" id="status-text">Traumsequenz</div>
    <div class="timeline-container" id="timeline">
        <div id="seeker"></div>
    </div>
    <button id="start-btn">STARTEN</button>
    <div id="feedback" style="margin-top: 20px; opacity: 0.6;"></div>
</div>

<script>
    let audioCtx, startTime, seeker, timeline, statusText;
    let phase = 'call'; 
    let pattern = [0.2, 0.5, 0.8]; 
    let userHits = [];
    const duration = 3000; 

    function createSoftSound(freq, vol = 0.15, dur = 0.4) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine'; // Weiche Sinuswelle
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    function spawnNotes() {
        document.querySelectorAll('.note').forEach(n => n.remove());
        pattern.forEach(pos => {
            const n = document.createElement('div');
            n.className = 'note';
            n.style.left = (pos * 100) + "%";
            timeline.appendChild(n);
        });
    }

    function gameLoop() {
        const now = performance.now();
        const progress = ((now - startTime) % duration) / duration;
        seeker.style.left = (progress * 100) + "%";

        if (progress < 0.01 && !this.locked) {
            this.locked = true;
            if (phase === 'call') {
                phase = 'response';
                statusText.innerText = "Dein Echo";
                userHits = [];
                document.querySelectorAll('.note').forEach(n => n.classList.remove('hit'));
            } else {
                if (userHits.length < pattern.length) {
                    document.getElementById('feedback').innerText = "Rhythmus wiederholen...";
                } else {
                    pattern = Array.from({length: 3}, () => 0.15 + Math.random() * 0.7);
                    document.getElementById('feedback').innerText = "Nächster Level";
                }
                phase = 'call';
                statusText.innerText = "Hör zu";
                spawnNotes();
            }
        }
        if (progress > 0.05) this.locked = false;

        if (phase === 'call') {
            const notes = document.querySelectorAll('.note');
            pattern.forEach((p, i) => {
                if (Math.abs(progress - p) < 0.008 && !notes[i].dataset.played) {
                    notes[i].classList.add('hit');
                    createSoftSound(440); // A4
                    notes[i].dataset.played = "true";
                    setTimeout(() => notes[i].dataset.played = "", 500);
                }
            });
        }
        requestAnimationFrame(gameLoop);
    }

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && phase === 'response') {
            const now = performance.now();
            const progress = ((now - startTime) % duration) / duration;
            let hitFound = false;

            pattern.forEach((p, i) => {
                const diff = Math.abs(progress - p);
                const notes = document.querySelectorAll('.note');

                if (diff < 0.05) { // Perfekt
                    notes[i].classList.add('success');
                    createSoftSound(440, 0.2); // A4
                    userHits.push(i);
                    hitFound = true;
                } else if (diff < 0.15) { // Leicht daneben
                    notes[i].classList.add('off-key');
                    // Spielt einen Halbton tiefer (Ab4 / 415.30Hz)
                    createSoftSound(415.30, 0.1); 
                    hitFound = true;
                }
            });
        }
    });

    document.getElementById('start-btn').onclick = function() {
        audioCtx = new AudioContext();
        this.style.display = 'none';
        spawnNotes();
        startTime = performance.now();
        gameLoop();
        // Sanfter Hintergrund-Beat
        setInterval(() => createSoftSound(60, 0.1, 0.5), 1500); 
    };
</script>
</body>
</html>
