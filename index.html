<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Melatonin | Perfect Logic</title>
    <style>
        :root {
            --bg: #14141f;
            --fire: #ff6d24;
            --glow: #ffcf40;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background: var(--bg); font-family: 'Inter', sans-serif;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }

        /* Spielbereich */
        .container {
            width: 1000px; height: 600px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(40px);
            border-radius: 40px; border: 1px solid rgba(255,255,255,0.05);
            position: relative; overflow: hidden;
        }

        .rope {
            position: absolute; top: 180px; width: 100%; height: 2px;
            background: rgba(255,255,255,0.1); z-index: 1;
        }

        /* Foto-Style */
        .photo {
            position: absolute; top: 180px; height: 180px;
            background: #fff; padding: 10px; padding-bottom: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform-origin: top center;
            z-index: 5;
            /* Der Burn-Effekt: Maske von links nach rechts */
            -webkit-mask-image: linear-gradient(to right, transparent var(--burn), black var(--burn));
            mask-image: linear-gradient(to right, transparent var(--burn), black var(--burn));
            --burn: 0%;
        }

        .photo-inner {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            position: relative;
        }

        /* Glühende Kante beim Brennen */
        .photo.is-burning::after {
            content: ''; position: absolute; top: 0; left: var(--burn);
            width: 15px; height: 100%; background: var(--glow);
            filter: blur(10px); box-shadow: 0 0 25px var(--fire);
            z-index: 10;
        }

        /* Zippo */
        .zippo-anchor {
            position: absolute; bottom: 80px; left: 50%;
            transform: translateX(-50%); width: 80px; height: 120px;
            z-index: 100;
        }

        .zippo-body {
            position: absolute; bottom: 0; width: 100%; height: 75px;
            background: #333; border-radius: 4px;
        }

        .zippo-lid {
            position: absolute; bottom: 75px; width: 100%; height: 35px;
            background: #444; border-radius: 4px 4px 0 0;
            transform-origin: left bottom; transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .open .zippo-lid { transform: rotate(-120deg) translateX(-5px); }

        .flame {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 24px; height: 50px; background: var(--fire);
            border-radius: 50% 50% 20% 20%; filter: blur(4px);
            opacity: 0; transition: opacity 0.05s;
            box-shadow: 0 0 30px var(--fire);
        }

        .open .flame { opacity: 1; animation: flicker 0.1s infinite; }

        @keyframes flicker { 50% { transform: translateX(-50%) scale(1.1); } }

        #start-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8);
            z-index: 1000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }

        button {
            padding: 20px 60px; font-size: 20px; border-radius: 50px;
            border: none; cursor: pointer; font-weight: bold; background: #fff;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <h1>MELATONIN LOGIC</h1>
        <p>Leertaste halten zum Brennen</p>
        <button id="start-btn">START</button>
    </div>
    
    <div class="rope"></div>
    <div id="game-track"></div>

    <div class="zippo-anchor" id="zippo">
        <div class="flame"></div>
        <div class="zippo-lid"></div>
        <div class="zippo-body"></div>
    </div>
</div>

<script>
    let audioCtx, startTime, isSpaceDown = false;
    let photos = [];
    const bpm = 90;
    const beatDuration = 60000 / bpm;
    const loopBeats = 8;
    const loopDuration = beatDuration * loopBeats;

    // --- AUDIO ---
    function playSound(freq, vol, dur, type='sine', delay=0) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
        g.gain.setValueAtTime(vol, audioCtx.currentTime + delay);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(audioCtx.currentTime + delay); o.stop(audioCtx.currentTime + delay + dur);
    }

    function playBurnNoise() {
        const buf = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
        const d = buf.getChannelData(0);
        for(let i=0; i<audioCtx.sampleRate; i++) d[i] = Math.random() * 2 - 1;
        const s = audioCtx.createBufferSource(); s.buffer = buf; s.loop = true;
        const g = audioCtx.createGain(); g.gain.value = 0.05;
        const f = audioCtx.createBiquadFilter(); f.frequency.value = 1000;
        s.connect(f); f.connect(g); g.connect(audioCtx.destination);
        s.start(); return g;
    }

    let burnGain;

    // --- GAME ENGINE ---
    function spawnLevel() {
        const track = document.getElementById('game-track');
        track.innerHTML = "";
        photos = [];
        // Melatonin-Style Pattern: 1, 2, 3-Hold
        const pattern = [
            { beat: 1, width: 100 },
            { beat: 2, width: 100 },
            { beat: 4, width: 300 }
        ];

        pattern.forEach(p => {
            const el = document.createElement('div');
            el.className = 'photo';
            el.style.width = p.width + "px";
            el.innerHTML = '<div class="photo-inner"></div>';
            track.appendChild(el);
            photos.push({ 
                el, 
                targetBeat: p.beat, 
                w: p.width,
                burnt: 0 
            });
        });
    }

    function update() {
        const now = performance.now();
        const elapsed = (now - startTime) % loopDuration;
        const currentBeat = elapsed / beatDuration;

        const containerWidth = 1000;
        const midPoint = containerWidth / 2;

        photos.forEach(p => {
            // Horizontale Bewegung basierend auf Beat
            // Das Bild soll bei targetBeat genau in der Mitte (Zippo) sein
            const speed = 200; // Pixel pro Beat
            const x = midPoint + (p.targetBeat - currentBeat) * speed;
            p.el.style.left = x + "px";

            // Collision Check für Burn
            const rect = p.el.getBoundingClientRect();
            const containerRect = document.querySelector('.container').getBoundingClientRect();
            const zippoPos = containerRect.left + midPoint;

            if (isSpaceDown && zippoPos >= rect.left && zippoPos <= rect.right) {
                // Brennen!
                p.el.classList.add('is-burning');
                const progress = (zippoPos - rect.left) / rect.width;
                const percent = Math.min(100, progress * 100);
                if (percent > p.burnt) {
                    p.burnt = percent;
                    p.el.style.setProperty('--burn', p.burnt + "%");
                }
                if (burnGain) burnGain.gain.setTargetAtTime(0.1, audioCtx.currentTime, 0.02);
            } else {
                p.el.classList.remove('is-burning');
                if (burnGain) burnGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
            }
        });

        // Lo-Fi Musik Taktung
        if (Math.floor(currentBeat) !== this.lastBeat) {
            this.lastBeat = Math.floor(currentBeat);
            if (this.lastBeat % 4 === 0) {
                playSound(130, 0.1, 2, 'triangle'); // Bass
                playSound(261, 0.05, 2, 'sine'); // Chord
            }
            playSound(440, 0.02, 0.1, 'sine'); // Tick
        }

        requestAnimationFrame(update);
    }

    // --- INPUT ---
    window.onkeydown = (e) => {
        if (e.code === 'Space' && !isSpaceDown) {
            isSpaceDown = true;
            document.getElementById('zippo').classList.add('open');
            playSound(1200, 0.05, 0.05, 'square'); // Zippo Klick
        }
    };

    window.onkeyup = (e) => {
        if (e.code === 'Space') {
            isSpaceDown = false;
            document.getElementById('zippo').classList.remove('open');
            playSound(800, 0.03, 0.05, 'square'); // Close Klick
        }
    };

    document.getElementById('start-btn').onclick = () => {
        audioCtx = new AudioContext();
        burnGain = playBurnNoise();
        document.getElementById('start-screen').style.display = 'none';
        startTime = performance.now();
        spawnLevel();
        update();
    };
</script>
</body>
</html>
