<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Melatonin | Perfect Burn</title>
    <style>
        :root {
            --bg: #0d0d12;
            --accent: #ffb7ce;
            --fire: #ff6d24;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            background: var(--bg); font-family: 'Inter', sans-serif;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }

        .glass-panel {
            width: 1000px; height: 600px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(50px);
            border-radius: 60px; border: 1px solid rgba(255,255,255,0.1);
            position: relative; overflow: hidden;
        }

        /* Die Leine */
        .rope {
            position: absolute; top: 140px; width: 100%; height: 2px;
            background: rgba(255,255,255,0.2); box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* Polaroid mit Burn-Overlay */
        .polaroid {
            position: absolute; top: 140px; height: 160px;
            background: #fff; padding: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform-origin: top center; display: flex;
            animation: sway 4s ease-in-out infinite alternate;
        }
        @keyframes sway { from { transform: rotate(-1.5deg); } to { transform: rotate(1.5deg); } }

        .polaroid-content {
            width: 100%; height: 100%; position: relative;
            background: linear-gradient(135deg, #a2d2ff, #ffb7ce);
            overflow: hidden;
        }

        /* Das "Verbrannte" Overlay */
        .burned-overlay {
            position: absolute; top: 0; left: 0; height: 100%;
            background: #222; width: 0%; /* Wächst beim Brennen */
            mix-blend-mode: multiply; opacity: 0.9;
        }

        /* Zippo Design */
        .zippo-container {
            position: absolute; bottom: 60px; left: 50%;
            transform: translateX(-50%); width: 80px; height: 120px;
        }

        .zippo-body {
            position: absolute; bottom: 0; width: 100%; height: 70px;
            background: #555; border-radius: 5px; z-index: 10;
        }

        .zippo-lid {
            position: absolute; bottom: 70px; width: 100%; height: 35px;
            background: #666; border-radius: 5px 5px 0 0;
            transform-origin: left bottom; transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 11;
        }

        .zippo-container.open .zippo-lid { transform: rotate(-110deg) translateX(-5px); }

        .flame {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 20px; height: 45px; background: var(--fire);
            border-radius: 50% 50% 20% 20%; filter: blur(3px);
            opacity: 0; box-shadow: 0 0 20px var(--fire);
        }
        .zippo-container.open .flame { opacity: 1; animation: flicker 0.1s infinite; }
        @keyframes flicker { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } }

        #btn-start {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 15px 40px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="glass-panel">
    <div class="rope"></div>
    <div id="track"></div>
    
    <div class="zippo-container" id="zippo">
        <div class="flame"></div>
        <div class="zippo-lid"></div>
        <div class="zippo-body"></div>
    </div>

    <button id="btn-start">TRAUM STARTEN</button>
</div>

<script>
    let audioCtx, startTime, pattern = [], activePhotos = [], isHolding = false;
    let burnSoundNode = null;
    const duration = 4500;

    // --- verbesserte AUDIO ENGINE ---
    function playSynth(freq, vol, dur, type='sine', delay=0) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
        g.gain.setValueAtTime(vol, audioCtx.currentTime + delay);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(audioCtx.currentTime + delay); o.stop(audioCtx.currentTime + delay + dur);
    }

    function createBurnNoise() {
        const bufSize = audioCtx.sampleRate * 1;
        const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
        const data = buf.getChannelData(0);
        for(let i=0; i<bufSize; i++) data[i] = Math.random() * 2 - 1;
        const src = audioCtx.createBufferSource(); src.buffer = buf; src.loop = true;
        const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 800;
        const g = audioCtx.createGain(); g.gain.value = 0;
        src.connect(filter); filter.connect(g); g.connect(audioCtx.destination);
        src.start();
        return { src, gain: g };
    }

    function playLoFiBackground() {
        const now = audioCtx.currentTime;
        // Rhodes-Style Akkorde
        [196, 246, 293, 349].forEach(f => playSynth(f, 0.03, 4, 'triangle')); // G7
        // Minimaler Bass
        playSynth(49, 0.1, 0.8, 'sine');
        setTimeout(() => playSynth(65, 0.1, 0.8, 'sine'), 1125);
    }

    // --- SPIEL LOGIK ---
    function createPattern() {
        return [
            { t: 0.2, w: 80 },  // Kurzer Hit
            { t: 0.5, w: 220 }, // Langer Hold
            { t: 0.85, w: 100 } // Mittlerer Hold
        ];
    }

    function spawn() {
        const track = document.getElementById('track');
        track.innerHTML = ""; activePhotos = [];
        pattern.forEach(p => {
            const el = document.createElement('div');
            el.className = 'polaroid';
            el.style.width = p.w + "px";
            el.style.left = "110%";
            el.innerHTML = `<div class="polaroid-content"><div class="burned-overlay"></div></div>`;
            track.appendChild(el);
            activePhotos.push({ el, overlay: el.querySelector('.burned-overlay'), t: p.t, w: p.w, burnPercent: 0 });
        });
    }

    function loop() {
        const now = performance.now();
        const progress = ((now - startTime) % duration) / duration;

        activePhotos.forEach(obj => {
            const xPos = (1.1 - (progress - obj.t + 1) % 1) * 100;
            obj.el.style.left = xPos + "%";

            // Collision Check (Mitte des Bildschirms ist das Zippo)
            const rect = obj.el.getBoundingClientRect();
            const zippoX = window.innerWidth / 2;

            if(isHolding && rect.left < zippoX && rect.right > zippoX) {
                // Berechne, welcher Teil des Bildes gerade über der Flamme ist
                const relativePos = (zippoX - rect.left) / rect.width;
                if(relativePos > obj.burnPercent / 100) {
                    obj.burnPercent = relativePos * 100;
                    obj.overlay.style.width = obj.burnPercent + "%";
                    burnSoundNode.gain.gain.setTargetAtTime(0.1, audioCtx.currentTime, 0.05);
                }
            } else if (isHolding) {
                // Flamme brennt, aber kein Bild da
                burnSoundNode.gain.gain.setTargetAtTime(0.02, audioCtx.currentTime, 0.1);
            }
        });

        if(!isHolding && burnSoundNode) burnSoundNode.gain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05);

        if(progress < 0.01 && !this.locked) {
            this.locked = true;
            playLoFiBackground();
            if(activePhotos.length > 0 && progress < 0.01) {
                // Check ob "reingekackt": Wenn Bilder nicht zu > 90% verbrannt sind
            }
            pattern = createPattern();
            spawn();
        }
        if(progress > 0.05) this.locked = false;
        requestAnimationFrame(loop);
    }

    window.onkeydown = (e) => {
        if(e.code === 'Space' && !isHolding) {
            isHolding = true;
            document.getElementById('zippo').classList.add('open');
            playSynth(1500, 0.05, 0.1, 'square'); // Metallischer Klick
        }
    };

    window.onkeyup = (e) => {
        if(e.code === 'Space') {
            isHolding = false;
            document.getElementById('zippo').classList.remove('open');
            playSynth(1200, 0.03, 0.05, 'square'); // Schließ-Klick
        }
    };

    document.getElementById('btn-start').onclick = function() {
        audioCtx = new AudioContext();
        burnSoundNode = createBurnNoise();
        this.style.display = 'none';
        startTime = performance.now();
        loop();
    };
</script>
</body>
</html>
