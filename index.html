<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>AULA | Rhythm Master</title>
    <style>
        :root {
            --bg: #0d0d12;
            --accent: #ffb7ce;
            --player: #a2d2ff;
            --error: #ff4b2b;
            --glass: rgba(255, 255, 255, 0.03);
        }

        body {
            margin: 0; background: var(--bg);
            color: white; font-family: 'Inter', sans-serif;
            display: flex; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden;
        }

        .container {
            width: 850px; padding: 50px;
            background: var(--glass);
            backdrop-filter: blur(50px);
            border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.08);
            text-align: center;
            box-shadow: 0 40px 120px rgba(0,0,0,0.8);
        }

        .timeline-container {
            position: relative;
            width: 100%; height: 120px;
            background: rgba(255,255,255,0.02);
            border-radius: 25px;
            margin: 40px 0;
            display: flex; align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
            overflow: hidden;
        }

        #seeker {
            position: absolute;
            left: 0; width: 6px; height: 100%;
            background: linear-gradient(to bottom, transparent, white, transparent);
            box-shadow: 0 0 25px white;
            z-index: 10;
        }

        .note {
            position: absolute;
            width: 45px; height: 45px;
            border-radius: 14px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--accent);
            transform: translateX(-50%);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .note.hit { background: var(--accent); box-shadow: 0 0 40px var(--accent); transform: translateX(-50%) scale(1.15); }
        .note.success { border-color: var(--player); background: var(--player); box-shadow: 0 0 40px var(--player); }
        .note.fail { border-color: var(--error); background: var(--error); box-shadow: 0 0 40px var(--error); }

        .status { font-size: 28px; font-weight: 100; letter-spacing: 12px; text-transform: uppercase; margin-bottom: 20px; color: var(--accent); }
        
        button {
            background: white; color: black; border: none; padding: 22px 60px;
            border-radius: 100px; font-weight: 900; cursor: pointer;
            font-size: 18px; transition: 0.4s;
        }
        button:hover { transform: scale(1.05); box-shadow: 0 0 30px var(--player); }
    </style>
</head>
<body>

<div class="container">
    <div class="status" id="status-text">Traum beginnt...</div>
    
    <div class="timeline-container" id="timeline">
        <div id="seeker"></div>
    </div>

    <button id="start-btn">VERBINDEN</button>
    <div id="feedback" style="margin-top: 25px; font-weight: bold; font-size: 20px;"></div>
</div>

<script>
    let audioCtx, startTime, seeker, timeline, statusText, feedback;
    let isPlaying = false;
    let phase = 'call'; 
    let pattern = [0.2, 0.4, 0.7]; 
    let userHits = [];
    const duration = 2800; 

    seeker = document.getElementById('seeker');
    timeline = document.getElementById('timeline');
    statusText = document.getElementById('status-text');
    feedback = document.getElementById('feedback');

    function createOsc(freq, type, dur, vol = 0.1) {
        if(!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    function generatePattern() {
        const count = 2 + Math.floor(Math.random() * 3); // 2 bis 4 Noten
        const newPattern = [];
        for(let i=0; i<count; i++) {
            newPattern.push(0.15 + (i * 0.2) + Math.random() * 0.15);
        }
        return newPattern;
    }

    function spawnNotes() {
        document.querySelectorAll('.note').forEach(n => n.remove());
        pattern.forEach(pos => {
            const n = document.createElement('div');
            n.className = 'note';
            n.style.left = (pos * 100) + "%";
            timeline.appendChild(n);
        });
    }

    function gameLoop() {
        const now = performance.now();
        const elapsed = (now - startTime) % duration;
        const progress = elapsed / duration;

        seeker.style.left = (progress * 100) + "%";

        // Takt-Ende erreicht
        if (progress < 0.015 && !this.locked) {
            this.locked = true;
            handlePhaseSwitch();
        }
        if (progress > 0.05) this.locked = false;

        // Call Phase Sound Logic
        if (phase === 'call') {
            const notes = document.querySelectorAll('.note');
            pattern.forEach((p, i) => {
                if (Math.abs(progress - p) < 0.008 && !notes[i].dataset.played) {
                    notes[i].classList.add('hit');
                    createOsc(523.25, 'triangle', 0.25, 0.15); // C5
                    notes[i].dataset.played = "true";
                    setTimeout(() => notes[i].dataset.played = "", 500);
                }
            });
        }
        requestAnimationFrame(gameLoop);
    }

    function handlePhaseSwitch() {
        if (phase === 'call') {
            phase = 'response';
            statusText.innerText = "Dein Echo";
            statusText.style.color = "var(--player)";
            userHits = [];
            document.querySelectorAll('.note').forEach(n => n.classList.remove('hit'));
        } else {
            const win = checkScore();
            if (win) {
                pattern = generatePattern();
                feedback.innerText = "Traum gemeistert! âœ¨";
                feedback.style.color = "var(--player)";
            } else {
                feedback.innerText = "Wiederhole den Traum... ðŸŒ™";
                feedback.style.color = "var(--error)";
            }
            phase = 'call';
            statusText.innerText = "HÃ¶r zu";
            statusText.style.color = "var(--accent)";
            spawnNotes();
        }
    }

    function checkScore() {
        // Erfolg wenn alle Noten im Pattern mindestens einmal in der NÃ¤he getroffen wurden
        return pattern.length > 0 && userHits.length === pattern.length;
    }

    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && phase === 'response') {
            const now = performance.now();
            const progress = ((now - startTime) % duration) / duration;
            
            let found = false;
            pattern.forEach((p, i) => {
                const diff = Math.abs(progress - p);
                const notes = document.querySelectorAll('.note');

                if (diff < 0.04) { // Perfektes Timing
                    if (!notes[i].classList.contains('success')) {
                        notes[i].classList.add('success');
                        createOsc(329.63, 'triangle', 0.3, 0.2); // E4 (Harmonisch)
                        userHits.push(i);
                        found = true;
                    }
                } else if (diff < 0.12) { // Schlechtes Timing (Dissonant)
                    notes[i].classList.add('fail');
                    createOsc(311.13, 'sawtooth', 0.4, 0.1); // Eb4 (Dissonanter Halbton!)
                    found = true; 
                }
            });

            if (!found) {
                // Komplett daneben
                createOsc(150, 'sine', 0.2, 0.2); 
            }
        }
    });

    document.getElementById('start-btn').onclick = function() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        this.style.display = 'none';
        pattern = generatePattern();
        spawnNotes();
        startTime = performance.now();
        gameLoop();
        // Bass Beat
        setInterval(() => createOsc(55, 'sine', 0.15, 0.3), duration / 4); 
    };
</script>
</body>
</html>
